# Discord & Web 連携 ユーザー申請管理システム

## 概要

Discordボットを介してユーザーからの登録申請を受け付け、管理者がローカルで動作するWebインターフェースを通じて申請内容を確認・承認し、安全にユーザーを管理するためのツール。

申請中のデータは **Firebase (Firestore)** に暗号化して一時保管され、管理者が承認したデータのみが、ローカルの **SQLite** データベースに平文で永続的に保存される仕組み。

## 主な機能

- **Discordからの申請**: ユーザーはDiscordの `/create` コマンドから直感的に登録申請を行うことができる。
- **安全なデータ転送**: 申請データは、管理者のみが知るマスターキーで暗号化され、安全に一時保管される。
- **QRコードによる承認フロー**: ボットは管理者向けの承認用URLを含んだQRコードを生成し、スムーズな連携を実現する。
- **ローカルWeb管理画面**: 管理者は自身のPC上でのみ動作するWebページで、以下の操作を実行できる。
    - 申請内容の確認と、承認・否認の実行。
    - 承認済みユーザーの一覧表示。
    - 名前やIDによるユーザー検索機能。
    - 各項目での並べ替え（ソート）機能。
    - 承認済みユーザーの削除機能（カスタム確認アラート付き）。

## システム構成

本システムは、以下の4つのコンポーネントが連携して動作する。

1.  **Discordボット (Node.js)**
    - ユーザーからの申請を受け付ける窓口。
    - 入力された情報を暗号化し、**Firebase**へ一時保存する。

2.  **Firebase (Firestore)**
    - 承認待ちの申請データを一時的に保管するクラウドデータベース。
    - データは暗号化されているため、万が一データベースが漏洩しても内容は保護される。

3.  **ローカルWebサーバー (Node.js / Express)**
    - 管理者のみが自身のPCでアクセスするWebインターフェースを提供する。
    - Firebaseから申請データを取得・復号し、承認処理を実行する。
    - ローカルの**SQLite**データベースを読み書きし、承認済みユーザーを管理する。

4.  **SQLite**
    - 承認されたユーザーデータを永続的に保存するローカルデータベースファイル。
    - データは平文で保存されるため、管理画面での検索やソートが容易。

### データフロー

`ユーザー` → `Discordボット` → `[暗号化]` → `Firebase` → `管理者` → `Webサーバー` → `[復号]` → `(承認)` → `SQLite`

## 必要なもの

- Node.js (v18.x 以上を推奨)
- Discordアカウントと、作成済みのDiscordボットアプリケーション
- Googleアカウントと、作成済みのFirebaseプロジェクト

## セットアップ手順

1.  **リポジトリのクローンと移動**
    ```bash
    git clone <リポジトリのURL>
    cd <リポジトリ名>
    ```

2.  **依存パッケージのインストール**
    ```bash
    npm install
    ```

3.  **`.env`ファイルの作成**
    プロジェクトのルートに `.env` という名前のファイルを作成し、以下の内容を記述する。

    ```env
    # Discordボットのトークン
    DISCORD_TOKEN=your_discord_bot_token

    # Firebaseのサービスアカウント情報（JSONを一行に圧縮して貼り付け）
    FIREBASE_SERVICE_ACCOUNT_JSON='{"type": "service_account", ...}'

    # 暗号化マスターキー（非常に重要）
    MASTER_ENCRYPTION_KEY="ここに非常に強力でランダムな秘密の文字列を生成して貼り付け"

    # ローカルWebサーバーのポート番号
    PORT=3000
    ```

4.  **環境変数の設定**
    - `DISCORD_TOKEN`: [Discord Developer Portal](https://discord.com/developers/applications)で、自身のボットのページから取得する。
    - `FIREBASE_SERVICE_ACCOUNT_JSON`:
        1.  [Firebase Console](https://console.firebase.google.com/)で自身のプロジェクトを開く。
        2.  `プロジェクトの設定` > `サービスアカウント` タブへ移動する。
        3.  「新しい秘密鍵の生成」ボタンを押し、キーファイル（JSON）をダウンロードする。
        4.  ダウンロードしたJSONファイルの中身を**すべてコピーし、改行を削除して一行の文字列にしたもの**を、`''`の中に貼り付けること。
    - `MASTER_ENCRYPTION_KEY`:
        - **【警告】このキーはシステムの心臓部である。一度設定したら絶対に紛失・変更してはならない。変更した場合、過去の申請データがすべて復号できなくなる。**
        - パスワード生成ツールなどを用い、64文字以上の英数字記号を混ぜた、推測不可能な文字列を設定すること。
    - `PORT`: ローカルWebサーバーが使用するポート番号。通常は`3000`のままで問題ない。

5.  **アプリケーションの起動**
    ```bash
    node index.js
    ```
    コンソールに「ボット起動完了」と「Webサーバー起動完了」のメッセージが表示されれば成功。

## 使用方法

### ユーザー向け

1.  Discordサーバーで `/create` コマンドを実行する。
2.  表示されたモーダルに、名前、読み仮名、Minecraft IDを入力して送信する。
3.  ボットから、管理者への申請用QRコードとURLが非表示メッセージで送られてくる。
4.  そのQRコードまたはURLを管理者に提示する。

### 管理者向け

1.  **申請の承認**
    - ユーザーから提示されたQRコードを読み取るか、URLをブラウザで開く。
    - ローカルWebサーバーが起動していれば、`http://localhost:3000/approve?code=...` のような承認ページが表示される。
    - 表示された申請内容（名前、IDなど）を確認し、「承認して登録」または「否認する」ボタンを押す。

2.  **承認済みユーザーの管理**
    - ブラウザで `http://localhost:3000/admin` にアクセスする。
    - ローカルのSQLiteに保存されている、承認済みの全ユーザーリストが表示される。
    - **検索**: 右上の検索ボックスにキーワードを入力して、ユーザーを絞り込むことができる。
    - **並べ替え**: テーブルのヘッダー（「ID」や「名前」など）をクリックすると、その項目でリストを並べ替えることができる。
    - **削除**: 各ユーザーの行にある「削除」ボタンを押すと、確認のポップアップが表示され、承認済みリストからユーザーを完全に削除できる。

## ファイル構成
```
.
├── commands/
│   └── create.js         # Discordスラッシュコマンドの定義
├── utils/
│   └── encryption.js     # 暗号化・復号ロジック
├── views/
│   ├── admin.ejs         # 管理ダッシュボードのWebページ
│   └── approve.ejs       # 申請承認用のWebページ
├── .env                    # 環境変数の設定ファイル (重要)
├── database.js             # SQLiteデータベースの初期化
├── firebase.js             # Firebase Admin SDKの初期化
├── index.js                # ボットとWebサーバーを起動するメインファイル
├── package.json
└── approved_users.db       # 承認済みユーザーが保存されるDBファイル (自動生成)
```

## ライセンス

[MIT License](LICENSE)
